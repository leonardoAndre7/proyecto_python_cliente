{% extends "banco/base.html" %}
{% block content %}
<div class="card p-3 mb-3">
  <h5>Vista previa - edita antes de importar</h5>
  <p class="text-muted">Edita saldo inicial, código, cliente o tarifa por fila. Los cálculos de Saldo y Comisión se actualizan en tiempo real.</p>

<style>
input.auto-width {
    width: auto;          /* tamaño mínimo según contenido */
    min-width: 80px;      /* ancho mínimo */
    max-width: 400px;     /* ancho máximo */
}
</style>


  <form method="post" action="{% url 'banco:confirmar_import' %}">
    {% csrf_token %}

    <div class="table-responsive table-fixed"> 
      <table class="table table-hover">
        <thead class="table-light">
          <tr> <!-- IMPORTANTE -->
            <!-- los datos del encabezado del excel debe ser igual al del excel }
             si no, nose importara los datos del excel al formulario del sistema-->
            <th>#</th>
            <th>Fecha</th>
            <th>Fecha Valuta</th>
            <th>Descripción_Operación</th>
            <th>Monto</th>
            <th>Sucursal_Agencia</th>
            <th>N_Operación</th>
            <th>Usuario</th>
            <th>Saldo inicial</th> 
            <th>Saldo</th> 
            <th>Comision</th> 
            <th>LM_Pagar</th> 
            <th>codigo_referido</th>
            <th>DNI</th>
            <th>Nombre</th>
            <th>Celular</th>
            <th>Tarifa_Status</th>
            <th>Provincia</th>
            <th>DNI Referido</th>
            <th>Nombre_Referido</th>
            <th>Cuenta_Bancaria</th>
            <th>Cuenta_Interbancaria</th>
            <th>Correo</th>
            <th>Ganancia_Referido</th>
            <th>Cod_tarifa</th>
          </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr data-index="{{ forloop.counter0 }}">
            <td>{{ forloop.counter }}</td>

            <td><input class="form-control form-control-sm auto-width" type="text" name="fecha" value="{{ r.fecha|default:'' }}"></td>
            <td><input class="form-control form-control-sm" type="text" name="fecha_valuta" value="{{ r.fecha_valuta|default:'' }}"></td>
            <td><input class="form-control form-control-sm auto-width" type="text" name="descripcion" value="{{ r.descripcion|default:'' }}"></td>
            <td><input class="form-control form-control-sm monto auto-width" type="decimal" name="monto" value="{{ r.monto }}"></td>
            <td><input class="form-control form-control-sm" type="text" name="sucursal_agencia" value="{{ r.sucursal_agencia }}"></td>
            <td><input class="form-control form-control-sm" type="text" name="n_operacion" value="{{ r.n_operacion }}"></td>
            <td><input class="form-control form-control-sm auto-width" type="text" name="usuario" value="{{ r.usuario }}"></td>

            <!-- Campos que van a salir automatizados -->
            <td><input class="form-control form-control-sm saldo_inicial" type="number" step="decimal" name="saldo_inicial" value="{{ r.saldo_inicial_default }}"></td>
            <td><input class="form-control form-control-sm saldo_calc auto-width" type="text" readonly value="{{ r.saldo }}"></td>
            <td><input class="form-control form-control-sm comision_calc" type="text" readonly value="{{ r.comision }}"></td>
            <td><input class="form-control form-control-sm" type="text" readonly value="{{ r.lm_pagar }}"></td>
            <!-- con reglas -->

            <td><input class="form-control form-control-sm" type="text" name="codigo" value=""></td>
            <td><input class="form-control form-control-sm auto-width" type="text"  value="{{ r.dni_cliente }}" readonly></td>
            <td><input class="form-control form-control-sm auto-width" type="text" name="cliente_nombre" value="{{ r.cliente_nombre }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.celular }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.status }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.provincia }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.codigo_referido }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.nombre_referido }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.cuenta_banco_referido }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.cuenta_interbancario_referido }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.correo }}" readonly></td>
            <td><input type="text" class="form-control form-control-sm auto-width" value="{{ r.Ganancia_Referido }}" readonly></td>
            <td>
              <input type="text" 
                    class="form-control form-control-sm auto-width" 
                    name="tarifa" 
                    value="{{ r.cod_tarifa }}" 
                    readonly>
              <input type="hidden" class="tarifa_percent" value="{{ r.costo_por_porcentaje }}">
              <input type="hidden" class="tarifa_fixed" value="{{ r.costo_fijo }}">
            </td>


            <!-- Campo oculto para enviar cod_cliente al backend -->
            <input type="hidden" name="cliente" value="{{ r.cliente_default }}">

          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <button class="btn btn-success">Confirmar e Exporta a la BD</button>
      <a href="{% url 'banco:confirmar_import' %}" class="btn btn-outline-secondary">Volver</a>
      <a href="{% url 'banco:exportar_excel' %}" class="btn btn-success">
          Descargar Excel
      </a>

    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function recalcRow($tr){
  const monto = parseFloat($tr.find('.monto').val() || 0);
  const saldo_inicial = parseFloat($tr.find('.saldo_inicial').val() || 0);

  const percent = parseFloat($tr.find('.tarifa_percent').val() || 0);
  const fixed = parseFloat($tr.find('.tarifa_fixed').val() || 0);

  const saldo = (monto + saldo_inicial).toFixed(2);
  $tr.find('.saldo_calc').val(saldo);

  let comision = 0;
  if (monto > 1500) {
    comision = monto * percent;
  } else {
    comision = fixed;
  }
  $tr.find('.comision_calc').val(parseFloat(comision).toFixed(2));
}

</script>
{% endblock %}
